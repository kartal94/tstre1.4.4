import asyncio
import time
from pyrogram import Client, filters, enums
from pyrogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from Backend.helper.custom_filter import CustomFilters
from pymongo import MongoClient, UpdateOne
import os

# -----------------------
stop_event = asyncio.Event()

# DATABASE sadece ortam deÄŸiÅŸkeninden okunacak
db_raw = os.getenv("DATABASE", "")
if not db_raw:
    raise Exception("DATABASE ortam deÄŸiÅŸkeni bulunamadÄ±!")

db_urls = [u.strip() for u in db_raw.split(",") if u.strip()]
if len(db_urls) < 2:
    raise Exception("Ä°kinci DATABASE bulunamadÄ±!")

MONGO_URL = db_urls[1]
client_db = MongoClient(MONGO_URL)
db_name = client_db.list_database_names()[0]
db = client_db[db_name]

movie_col = db["movie"]
series_col = db["tv"]
# -----------------------

# ----- STOP CALLBACK -----
@Client.on_callback_query(filters.regex("stop"))
async def stop_callback(client, callback_query):
    stop_event.set()
    await callback_query.answer("Ä°ÅŸlem iptal edildi!")

# ----- TEK SEFERDE TÃœRLER VE PLATFORM -----
@Client.on_message(filters.command("tur") & filters.private & CustomFilters.owner)
async def tur_ve_platform_duzelt(client: Client, message):
    stop_event.clear()
    
    start_msg = await message.reply_text(
        "ğŸ”„ TÃ¼r ve platform gÃ¼ncellemesi baÅŸlatÄ±ldÄ±â€¦",
        reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("âŒ Ä°ptal Et", callback_data="stop")]]),
    )
    
    genre_map = {
        "Action": "Aksiyon", "Film-Noir": "Kara Film", "Game-Show": "Oyun GÃ¶sterisi", "Short": "KÄ±sa",
        "Sci-Fi": "Bilim Kurgu", "Sport": "Spor", "Adventure": "Macera", "Animation": "Animasyon",
        "Biography": "Biyografi", "Comedy": "Komedi", "Crime": "SuÃ§", "Documentary": "Belgesel",
        "Drama": "Dram", "Family": "Aile", "News": "Haberler", "Fantasy": "Fantastik",
        "History": "Tarih", "Horror": "Korku", "Music": "MÃ¼zik", "Musical": "MÃ¼zikal",
        "Mystery": "Gizem", "Romance": "Romantik", "Science Fiction": "Bilim Kurgu",
        "TV Movie": "TV Filmi", "Thriller": "Gerilim", "War": "SavaÅŸ", "Western": "VahÅŸi BatÄ±",
        "Action & Adventure": "Aksiyon ve Macera", "Kids": "Ã‡ocuklar", "Reality": "GerÃ§eklik",
        "Reality-TV": "GerÃ§eklik", "Sci-Fi & Fantasy": "Bilim Kurgu ve Fantazi", "Soap": "Pembe Dizi",
        "War & Politics": "SavaÅŸ ve Politika", "Bilim-Kurgu": "Bilim Kurgu",
        "Aksiyon & Macera": "Aksiyon ve Macera", "SavaÅŸ & Politik": "SavaÅŸ ve Politika",
        "Bilim Kurgu & Fantazi": "Bilim Kurgu ve Fantazi", "Talk": "Talk-Show"
    }

    platform_genre_map = {
        "MAX": "Max", "Hbomax": "Max", "TABÄ°Ä°": "Tabii", "NF": "Netflix", "DSNP": "Disney",
        "Tod": "Tod", "Blutv": "Max", "Tv+": "Tv+", "Exxen": "Exxen",
        "Gain": "Gain", "HBO": "Max", "Tabii": "Tabii", "AMZN": "Amazon",
    }

    collections = [
        (movie_col, "Filmler"),
        (series_col, "Diziler")
    ]

    total_fixed = 0
    last_update = 0

    for col, name in collections:
        docs_cursor = col.find({}, {"_id": 1, "genres": 1, "telegram": 1, "seasons": 1})
        bulk_ops = []

        for doc in docs_cursor:
            if stop_event.is_set():
                break

            doc_id = doc["_id"]
            genres = doc.get("genres", [])
            updated = False

            new_genres = []
            for g in genres:
                if g in genre_map:
                    new_genres.append(genre_map[g])
                    updated = True
                else:
                    new_genres.append(g)
            genres = new_genres

            for t in doc.get("telegram", []):
                name_field = t.get("name", "").lower()
                for key, genre_name in platform_genre_map.items():
                    if key.lower() in name_field and genre_name not in genres:
                        genres.append(genre_name)
                        updated = True

            for season in doc.get("seasons", []):
                for ep in season.get("episodes", []):
                    for t in ep.get("telegram", []):
                        name_field = t.get("name", "").lower()
                        for key, genre_name in platform_genre_map.items():
                            if key.lower() in name_field and genre_name not in genres:
                                genres.append(genre_name)
                                updated = True

            if updated:
                bulk_ops.append(UpdateOne({"_id": doc_id}, {"$set": {"genres": genres}}))
                total_fixed += 1

            if time.time() - last_update > 5:
                try:
                    await start_msg.edit_text(
                        f"{name}: GÃ¼ncellenen kayÄ±tlar: {total_fixed}",
                        reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("âŒ Ä°ptal Et", callback_data="stop")]]),
                    )
                except:
                    pass
                last_update = time.time()

        if bulk_ops:
            col.bulk_write(bulk_ops)

    try:
        await start_msg.edit_text(
            f"âœ… TÃ¼r ve platform gÃ¼ncellemesi tamamlandÄ±.\nToplam deÄŸiÅŸtirilen kayÄ±t: {total_fixed}",
            parse_mode=enums.ParseMode.MARKDOWN
        )
    except:
        pass
